"use strict";(()=>{var e={};e.id=1770,e.ids=[1770],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},9523:e=>{e.exports=require("dns")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},67180:(e,r,s)=>{s.r(r),s.d(r,{headerHooks:()=>g,originalPathname:()=>T,patchFetch:()=>A,requestAsyncStorage:()=>I,routeModule:()=>R,serverHooks:()=>P,staticGenerationAsyncStorage:()=>O,staticGenerationBailout:()=>S});var t={};s.r(t),s.d(t,{GET:()=>d,POST:()=>m});var i=s(26040),n=s(7623),o=s(52816),a=s(41912),_=s(44132),c=s(85685),u=s(75409),p=s(95431),E=s(78827);let l=(0,s(38055).G)("/dashboard/billing");async function d(e){try{let e=await (0,a.getServerSession)(u.L);if(!e?.user||!e?.user.email)return new Response(null,{status:403});let r=await (0,E.b)(e.user.id);if(console.log("subscriptionPlan",r),console.log("session.user.id",e.user.id),r.isPro&&r.stripeCustomerId){console.log("26");let e=await p.A.billingPortal.sessions.create({customer:r.stripeCustomerId,return_url:l});return new Response(JSON.stringify({url:e.url}))}console.log("36",e.user.id);let s=await p.A.checkout.sessions.create({success_url:l,cancel_url:l,payment_method_types:["card"],mode:"subscription",billing_address_collection:"auto",customer_email:e.user.email,subscription_data:{trial_settings:{end_behavior:{missing_payment_method:"cancel"}},trial_period_days:5},payment_method_collection:"if_required",line_items:[{price:c.H.stripePriceId,quantity:1}],metadata:{userId:e.user.id},client_reference_id:e.user.id});return new Response(JSON.stringify({url:s.url}))}catch(e){if(console.error(e.message),e instanceof _.z.ZodError)return new Response(JSON.stringify(e.issues),{status:422});return new Response(null,{status:500})}}async function m(e){let r={MooveTraxFree30:"promo_1PjDbOEMoWxHrnV9gw3vlujP",GWatersFree30:"promo_1PjDbOEMoWxHrnV9gw3vlujP",WeCarFree30:"promo_1PjUNjEMoWxHrnV9QiCYZgrr",start:"start"};try{let s=(await e.json()).data;console.log("promoCode",s);let t=await (0,a.getServerSession)(u.L);if(!t?.user||!t?.user.email)return new Response(null,{status:403});let i=await (0,E.b)(t.user.id);if(console.log("subscriptionPlan",i),console.log("session.user.id",t.user.id),i.isPro&&i.stripeCustomerId){console.log("26");let e=await p.A.billingPortal.sessions.create({customer:i.stripeCustomerId,return_url:l});return new Response(JSON.stringify({url:e.url}))}if(console.log("36",t.user.id),"start"==r[s]){let e=await p.A.checkout.sessions.create({success_url:l,cancel_url:l,payment_method_types:["card"],mode:"subscription",billing_address_collection:"auto",customer_email:t.user.email,subscription_data:{trial_settings:{end_behavior:{missing_payment_method:"cancel"}},trial_period_days:5},payment_method_collection:"if_required",line_items:[{price:c.H.stripePriceId,quantity:1}],metadata:{userId:t.user.id},client_reference_id:t.user.id});return new Response(JSON.stringify({url:e.url}))}{let e=await p.A.checkout.sessions.create({success_url:l,cancel_url:l,payment_method_types:["card"],mode:"subscription",billing_address_collection:"auto",customer_email:t.user.email,subscription_data:{trial_settings:{end_behavior:{missing_payment_method:"cancel"}}},payment_method_collection:"if_required",discounts:[{promotion_code:r[s]}],line_items:[{price:c.H.stripePriceId,quantity:1}],metadata:{userId:t.user.id},client_reference_id:t.user.id});return new Response(JSON.stringify({url:e.url}))}}catch(e){if(console.error(e.message),e instanceof _.z.ZodError)return new Response(JSON.stringify(e.issues),{status:422});return new Response(null,{status:500})}}let R=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/users/stripe/route",pathname:"/api/users/stripe",filename:"route",bundlePath:"app/api/users/stripe/route"},resolvedPagePath:"/Users/morganfuller/Documents/Invoke/ReelSearch/temp/ReelSearch/app/api/users/stripe/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:I,staticGenerationAsyncStorage:O,serverHooks:P,headerHooks:g,staticGenerationBailout:S}=R,T="/api/users/stripe/route";function A(){return(0,o.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:O})}},85685:(e,r,s)=>{s.d(r,{H:()=>n,R:()=>i});var t=s(47980);let i={name:"Free",description:"The free plan has limited features to view daily vehicle pricing data.",stripePriceId:""},n={name:"PRO",description:"PRO plan: Advanced data vizualization, revenue and market analysis, plus reelSearch+ChatGPT",stripePriceId:t.O.STRIPE_PRO_MONTHLY_PLAN_ID||""}},47980:(e,r,s)=>{s.d(r,{O:()=>n});var t=s(7487),i=s(44132);let n=(0,t.D)({server:{apiKey:i.z.string().min(1),appId:i.z.string().min(1),auth_provider_x509_cert_url:i.z.string().min(1),auth_uri:i.z.string().min(1),authDomain:i.z.string().min(1),client_email:i.z.string().min(1),client_id:i.z.string().min(1),client_x509_cert_url:i.z.string().min(1),DATABASE_URL:i.z.string().min(1),GOOGLE_CLIENT_ID:i.z.string().min(1),GOOGLE_CLIENT_SECRET:i.z.string().min(1),measurementId:i.z.string().min(1),messagingSenderId:i.z.string().min(1),NEXT_PUBLIC_APP_URL:i.z.string().min(1),NEXT_PUBLIC_FACEBOOK_PIXEL_ID:i.z.string().min(1),NEXTAUTH_SECRET:i.z.string().min(1),NEXTAUTH_URL:i.z.string().url().optional(),OPENAI_API_KEY:i.z.string().min(1),OPENAI_ORG_ID:i.z.string().min(1),PINECONE_KEY:i.z.string().min(1),private_key:i.z.string().min(1),private_key_id:i.z.string().min(1),FACEBOOKCONVTOKEN:i.z.string().min(1),projectId:i.z.string().min(1),storageBucket:i.z.string().min(1),STRIPE_API_KEY:i.z.string().min(1),STRIPE_PRO_MONTHLY_PLAN_ID:i.z.string().min(1),STRIPE_WEBHOOK_SECRET:i.z.string().min(1),token_uri:i.z.string().min(1),type:i.z.string().min(1),universe_domain:i.z.string().min(1),EMAIL_SERVER_USER:i.z.string().min(1),EMAIL_SERVER_PASSWORD:i.z.string().min(1),EMAIL_SERVER_HOST:i.z.string().min(1),EMAIL_SERVER_PORT:i.z.string().min(1),EMAIL_FROM:i.z.string().min(1)},client:{NEXT_PUBLIC_APP_URL:i.z.string().min(1)},runtimeEnv:{apiKey:process.env.apiKey,appId:process.env.appId,auth_provider_x509_cert_url:process.env.auth_provider_x509_cert_url,auth_uri:process.env.auth_uri,authDomain:process.env.authDomain,client_email:process.env.client_email,client_id:process.env.client_id,client_x509_cert_url:process.env.client_x509_cert_url,DATABASE_URL:process.env.DATABASE_URL,GOOGLE_CLIENT_ID:process.env.GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET:process.env.GOOGLE_CLIENT_SECRET,measurementId:process.env.measurementId,messagingSenderId:process.env.messagingSenderId,NEXT_PUBLIC_APP_URL:"http://localhost:3000",NEXT_PUBLIC_FACEBOOK_PIXEL_ID:"877663831030809",NEXTAUTH_SECRET:process.env.NEXTAUTH_SECRET,NEXTAUTH_URL:process.env.NEXTAUTH_URL,OPENAI_API_KEY:process.env.OPENAI_API_KEY,OPENAI_ORG_ID:process.env.OPENAI_ORG_ID,PINECONE_KEY:process.env.PINECONE_KEY,private_key:process.env.private_key,private_key_id:process.env.FACEBOOKCONVTOKEN,FACEBOOKCONVTOKEN:process.env.PINECONE_KEY,projectId:process.env.projectId,storageBucket:process.env.storageBucket,STRIPE_API_KEY:process.env.STRIPE_API_KEY,STRIPE_PRO_MONTHLY_PLAN_ID:process.env.STRIPE_PRO_MONTHLY_PLAN_ID,STRIPE_WEBHOOK_SECRET:process.env.STRIPE_WEBHOOK_SECRET,token_uri:process.env.token_uri,type:process.env.type,universe_domain:process.env.universe_domain,NEXTAUTH_URL:process.env.NEXTAUTH_URL,NEXTAUTH_SECRET:process.env.NEXTAUTH_SECRET,DATABASE_URL:process.env.DATABASE_URL,STRIPE_API_KEY:process.env.STRIPE_API_KEY,STRIPE_WEBHOOK_SECRET:process.env.STRIPE_WEBHOOK_SECRET,STRIPE_PRO_MONTHLY_PLAN_ID:process.env.STRIPE_PRO_MONTHLY_PLAN_ID,NEXT_PUBLIC_APP_URL:"http://localhost:3000",GOOGLE_CLIENT_ID:process.env.GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET:process.env.GOOGLE_CLIENT_SECRET,NEXT_PUBLIC_FACEBOOK_PIXEL_ID:"877663831030809",EMAIL_SERVER_USER:process.env.EMAIL_SERVER_USER,EMAIL_SERVER_PASSWORD:process.env.EMAIL_SERVER_PASSWORD,EMAIL_SERVER_HOST:process.env.EMAIL_SERVER_PASSWORD,EMAIL_SERVER_PORT:process.env.EMAIL_SERVER_PASSWORD,EMAIL_FROM:process.env.EMAIL_SERVER_PASSWORD}})},75409:(e,r,s)=>{s.d(r,{L:()=>c});var t=s(5100),i=s(60318),n=s(18110),o=s(54124),a=s(47980),_=s(84808);(0,o.createTransport)({host:process.env.EMAIL_SERVER_HOST,port:process.env.EMAIL_SERVER_PORT,secure:!0,auth:{user:process.env.EMAIL_SERVER_USER,pass:process.env.EMAIL_SERVER_PASSWORD}});let c={adapter:(0,t.N)(_.db),session:{strategy:"jwt"},pages:{signIn:"/login"},providers:[(0,n.Z)({clientId:a.O.GOOGLE_CLIENT_ID,clientSecret:a.O.GOOGLE_CLIENT_SECRET,allowDangerousEmailAccountLinking:!0}),(0,i.Z)({server:{host:process.env.EMAIL_SERVER_HOST,port:process.env.EMAIL_SERVER_PORT,auth:{user:process.env.EMAIL_SERVER_USER,pass:process.env.EMAIL_SERVER_PASSWORD}},from:process.env.EMAIL_FROM,sendVerificationRequest:async({identifier:e,url:r,provider:s})=>{let{server:t,from:i}=s,n=(0,o.createTransport)(t),a={to:e,from:i,subject:`Sign in to ${process.env.NEXTAUTH_URL}`,text:`Sign in to ${process.env.NEXTAUTH_URL}
${r}

`,html:`<p>Sign in to <strong>${process.env.NEXTAUTH_URL}</strong></p><p><a href="${r}">Click here to sign in</a></p>`};await n.sendMail(a)}})],callbacks:{session:async({token:e,session:r})=>(e&&(r.user.id=e.id,r.user.name=e.name,r.user.email=e.email,r.user.image=e.picture,r.user.fleetMemberships=e.fleetMemberships),r),async jwt({token:e,user:r}){let s=await _.db.user.findFirst({where:{email:e.email},include:{fleetMemberships:{select:{id:!0,fleet:{select:{name:!0,id:!0}}}}}});return s?{id:s.id,name:s.name,email:s.email,picture:s.image,fleetMemberships:s.fleetMemberships}:(r&&(e.id=r?.id),e)}}}},84808:(e,r,s)=>{s.d(r,{db:()=>t});let t=new(s(53524)).PrismaClient},95431:(e,r,s)=>{s.d(r,{A:()=>n});var t=s(42774),i=s(47980);let n=new t.Z(i.O.STRIPE_API_KEY,{apiVersion:"2022-11-15",typescript:!0})},78827:(e,r,s)=>{s.d(r,{b:()=>n});var t=s(85685),i=s(84808);async function n(e){let r=await i.db.user.findFirst({where:{id:e},select:{stripeSubscriptionId:!0,stripeCurrentPeriodEnd:!0,stripeCustomerId:!0,stripePriceId:!0}});if(!r)throw Error("User not found");let s=r.stripePriceId&&r.stripeCurrentPeriodEnd?.getTime()+864e5>Date.now();return{...s?t.H:t.R,...r,stripeCurrentPeriodEnd:r.stripeCurrentPeriodEnd?.getTime(),isPro:s}}},38055:(e,r,s)=>{s.d(r,{G:()=>_,cn:()=>o,p:()=>a});var t=s(61611),i=s(94021),n=s(47980);function o(...e){return(0,i.m)((0,t.W)(e))}function a(e){return new Date(e).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}function _(e){return`${n.O.NEXT_PUBLIC_APP_URL}${e}`}},26040:(e,r,s)=>{e.exports=s(30517)}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[5046,4132,863,3613,4539,2774],()=>s(67180));module.exports=t})();